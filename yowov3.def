Bootstrap: docker
From: pytorch/pytorch:2.5.0-cuda12.1-cudnn9-devel

%labels
    Maintainer tokumasu
    Description "Optimized ML/DL environment"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH=/opt/conda/bin:$PATH
    export TZ=Asia/Tokyo
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

%post
    # 非対話型モードの設定
    export DEBIAN_FRONTEND=noninteractive

    # パッケージインストールとタイムゾーン設定（単一コマンド化）
    apt-get update && apt-get install -y --no-install-recommends \
        tzdata \
        build-essential \
        tmux screen tree \
        vim  wget curl git ca-certificates sudo gnupg \
        htop iotop lsof ncdu \
        pciutils usbutils \
        neofetch \
        python3 python3-pip python3-dev python3-venv \
        iputils-ping net-tools \
        unzip zip \
        ffmpeg \
        software-properties-common \
        cmake pkg-config \
        libgl1 libglx-mesa0 \
        libglib2.0-0 libsm6 libxext6 libxrender1 \
        && \
    echo "Asia/Tokyo" > /etc/timezone && \
    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime && \
    dpkg-reconfigure --frontend noninteractive tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

    # Condaパス設定
    echo 'export PATH=/opt/conda/bin:$PATH' >> /environment

    # Mambaのインストールとベース環境構築（単一コマンド化）
    /opt/conda/bin/conda install -n base -y -c conda-forge mamba && \
    /opt/conda/bin/mamba install -n base -y -c defaults -c conda-forge \
        numpy pandas scipy matplotlib seaborn scikit-learn \
        jupyterlab notebook ipython \
        opencv pillow tqdm transformers datasets einops moviepy \

    # pipパッケージのインストール（キャッシュ無効化）
    /opt/conda/bin/pip install --no-cache-dir --upgrade pip openmim && \
    /opt/conda/bin/pip install --no-cache-dir \
        thop rich pycocotools shapely terminaltables yapf opencv-python-headless onnxruntime

%runscript
    exec /bin/bash

%test
    echo "[System Validation]"
    echo "1. Conda Version: $(/opt/conda/bin/conda --version)"
    echo "2. Python Path: $(which python)"
    echo "3. PyTorch Version: $(python -c 'import torch; print(torch.__version__)')"
