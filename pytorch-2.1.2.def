Bootstrap: docker
From: pytorch/pytorch:2.1.2-cuda12.1-cudnn8-devel

%labels
    Maintainer tokumasu
    Description "ML/DL environment with uv, CUDA 12.1, and common system libs"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export TZ=Asia/Tokyo
    export CUDA_HOME=/usr/local/cuda
    export PATH=/usr/local/bin:$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121
    export UV_CACHE_DIR=/tmp/uv-cache

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y --no-install-recommends \
        build-essential cmake pkg-config git wget curl vim \
        tmux screen tree htop unzip zip \
        python3 python3-dev python3-venv \
        libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgtk-3-dev \
        libjpeg-dev libpng-dev libtiff-dev libwebp-dev \
        libavcodec-dev libavformat-dev libswscale-dev \
        libatlas-base-dev libtbb2 libtbb-dev \
        libv4l-dev v4l-utils libopencv-dev python3-opencv \
        fonts-noto-cjk \
        && rm -rf /var/lib/apt/lists/*

    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
    dpkg-reconfigure --frontend noninteractive tzdata

    # uv を /usr/local/bin にインストールする．
    curl -LsSf https://astral.sh/uv/install.sh | UV_INSTALL_DIR=/usr/local/bin sh

    chmod a+rx /usr/local/bin/uv /usr/local/bin/uvx

%runscript
    exec /bin/bash "$@"