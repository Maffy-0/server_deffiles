Bootstrap: docker
From: pytorch/pytorch:2.5.0-cuda12.1-cudnn9-devel

%labels
    Maintainer tokumasu
    Description "ML/DL environment with OpenCV, PyInstaller, and common libraries (no conda/mamba)"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export TZ=Asia/Tokyo
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y --no-install-recommends \
        build-essential cmake pkg-config git wget curl vim \
        tmux screen tree htop unzip zip \
        python3 python3-pip python3-dev \
        libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgtk-3-dev \
        libjpeg-dev libpng-dev libtiff-dev libwebp-dev \
        libavcodec-dev libavformat-dev libswscale-dev \
        libatlas-base-dev libtbb2 libtbb-dev \
        libv4l-dev v4l-utils libopencv-dev python3-opencv \
        && rm -rf /var/lib/apt/lists/*

    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
    dpkg-reconfigure --frontend noninteractive tzdata

    pip3 install --no-cache-dir --upgrade pip
    pip3 install --no-cache-dir \
        numpy pandas scipy matplotlib seaborn scikit-learn \
        torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121 \
        jupyterlab notebook ipython \
        pillow tqdm opencv-python opencv-python-headless moviepy \
        transformers datasets \
        einops thop rich pycocotools shapely terminaltables yapf onnxruntime \
        xgboost lightgbm catboost albumentations \
        pyinstaller

%runscript
    exec /bin/bash "$@"

%test
    echo "[Test] Python version: $(python3 --version)"
    echo "[Test] PyTorch version: $(python3 -c 'import torch; print(torch.__version__)')"
    echo "[Test] OpenCV version: $(python3 -c 'import cv2; print(cv2.__version__)')"
    echo "[Test] PyInstaller version: $(pyinstaller --version)"
