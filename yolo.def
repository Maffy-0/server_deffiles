Bootstrap: docker
From: pytorch/pytorch:2.5.0-cuda12.1-cudnn9-devel

%labels
    Maintainer tokumasu
    Description "ML/DL environment with OpenCV (headless), PyInstaller, and comprehensive libraries (no conda/mamba; MySQL/PostgreSQL/Pyro/Dash除外)"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export TZ=Asia/Tokyo
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y --no-install-recommends \
        build-essential cmake pkg-config git wget curl vim tzdata \
        tmux screen tree htop unzip zip less rclone \
        software-properties-common ca-certificates gnupg lsb-release \
        sudo locales bash-completion \
        python3 python3-pip python3-dev python3-venv \
        python3-setuptools python3-wheel python3-numpy \
        python3-scipy python3-pandas python3-matplotlib \
        python3-sympy python3-h5py python3-seaborn \
        python3-sklearn python3-ipython \
        python3-tk \
        libgl1-mesa-glx libgl1-mesa-dev libglu1-mesa-dev libglew-dev \
        libglib2.0-0 libglib2.0-dev libsm6 libxext6 libxrender-dev libgtk-3-dev \
        libjpeg-dev libpng-dev libtiff-dev libwebp-dev \
        libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libpostproc-dev \
        libv4l-dev v4l-utils libdc1394-dev \
        libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
        libatlas-base-dev libtbb2 libtbb-dev \
        libopenblas-dev liblapack-dev libeigen3-dev gfortran \
        sqlite3 libsqlite3-dev libhdf5-dev \
        libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev libffi-dev \
        openssh-client openssh-server net-tools iputils-ping \
        nmap tcpdump iproute2 dnsutils telnet socat \
        curlftpfs sshfs rsync \
        uidmap fuse3 squashfs-tools \
        apache2-utils nginx-light \
        fonts-dejavu fonts-noto-cjk locales \
        x11-apps xvfb xauth xterm \
        texlive texlive-latex-extra texlive-fonts-recommended \
        texlive-lang-cjk dvipng \
        gdb strace ltrace valgrind \
        jq ncdu neofetch lsof multitail libimage-exiftool-perl imagemagick exiv2\
        && rm -rf /var/lib/apt/lists/*

    # タイムゾーン設定
    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
    dpkg-reconfigure --frontend noninteractive tzdata || true

    # pip アップグレード → 各種 Python ライブラリ一括導入
    pip3 install --no-cache-dir --upgrade pip
    pip3 install --no-cache-dir \
        numpy pandas scipy scikit-learn scikit-image statsmodels \
        matplotlib seaborn plotly bokeh \
        torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121 \
        tensorflow tensorflow-addons keras jax flax optax \
        pytorch-lightning fastai transformers datasets tokenizers sentencepiece \
        opencv-python-headless pillow imageio imageio-ffmpeg pycocotools albumentations segmentation-models-pytorch \
        gym gym[atari] stable-baselines3 ray[rllib] \
        nltk spacy sentence-transformers textblob gensim \
        xgboost lightgbm catboost \
        jupyterlab notebook ipython ipykernel nbconvert nbformat ipywidgets \
        flask fastapi uvicorn starlette django streamlit gradio \
        sqlalchemy redis boto3 google-cloud-storage azure-storage-blob \
        pyarrow fastparquet tables openpyxl xlrd h5py \
        requests urllib3 beautifulsoup4 lxml html5lib scrapy selenium \
        click tqdm loguru structlog pytest pytest-cov hypothesis flake8 black isort yapf \
        dill cloudpickle joblib \
        psutil line-profiler memory-profiler tensorboard \
        fabric paramiko invoke \
        sphinx sphinx-rtd-theme mkdocs \
        pyyaml ruamel.yaml toml jsonschema \
        regex fire markdown mistune moviepy ffmpeg-python \
        pyinstaller twine \
        shapely geopandas fiona rtree networkx \
        pymc3 arviz optuna \
        panel \
        gdown \
        ultralytics

%runscript
    exec /bin/bash "$@"

%test
    echo "[Test] Python version: $(python3 --version)"
    echo "[Test] PyTorch version: $(python3 -c 'import torch; print(torch.__version__)')"
    echo "[Test] TensorFlow version: $(python3 -c 'import tensorflow as tf; print(tf.__version__)')"
    echo "[Test] OpenCV version: $(python3 -c 'import cv2; print(cv2.__version__)')"
    echo "[Test] JupyterLab version: $(python3 -c 'import jupyterlab; print(jupyterlab.__version__)')"
    echo "[Test] PyInstaller version: $(pyinstaller --version)"
    echo "[Test] gdown check: $(python3 -c 'import gdown; print(gdown.__version__)')"
