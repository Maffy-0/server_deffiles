Bootstrap: docker
From: pytorch/pytorch:2.5.0-cuda12.1-cudnn9-devel

%labels
    Maintainer tokumasu
    Version v1.4-optimized
    Description "Robust ML/DL + OpenCV GUI environment with conflict-free pip setup and optimized Ubuntu 24.04 for mmaction2"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH=/opt/conda/bin:$PATH
    export TZ=Asia/Tokyo
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

%files
    /mnt/nas/home/tokumasu/mmcv       /opt/mmcv
    /mnt/nas/home/tokumasu/mmaction2  /opt/mmaction2

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y --no-install-recommends \
        tzdata \
        build-essential \
        cmake pkg-config \
        vim wget curl git ca-certificates sudo gnupg \
        tmux screen tree \
        htop iotop lsof ncdu \
        pciutils usbutils \
        unzip zip \
        software-properties-common \
        python3 python3-pip python3-dev python3-venv \
        iputils-ping net-tools \
        ffmpeg \
        libgl1 libglx-mesa0 libegl1 libgbm1 \
        libx11-6 libx11-xcb1 libxext6 libxfixes3 libxrender1 \
        libxi6 libxrandr2 libxcomposite1 libxcursor1 libxdamage1 libxinerama1 \
        libxcb1 libxcb-shm0 libxcb-shape0 libxcb-xfixes0 libxcb-randr0 \
        libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
        libxcb-render0 libxcb-xinerama0 libxcb-cursor0 libxft2 \
        libsm6 libglib2.0-0 libatk1.0-0 libatk-bridge2.0-0 libpango-1.0-0 \
        libgtk-3-0 \
        cron at \
        neofetch \
    && \
    echo "Asia/Tokyo" > /etc/timezone && \
    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime && \
    dpkg-reconfigure --frontend noninteractive tzdata && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

    echo 'export PATH=/opt/conda/bin:$PATH' >> /environment

    /opt/conda/bin/conda install -n base -y -c conda-forge mamba && \
    /opt/conda/bin/mamba install -n base -y -c defaults -c conda-forge \
        numpy pandas scipy matplotlib seaborn scikit-learn \
        jupyterlab notebook ipython \
        opencv pillow tqdm transformers datasets einops moviepy

    # pip: 安定バージョンで競合防止と追加パッケージ
    /opt/conda/bin/pip install --no-cache-dir --upgrade pip==25.1.1 setuptools==72.1.0 requests==2.32.3 tqdm==4.66.5 && \
    /opt/conda/bin/pip install --no-cache-dir \
        openmim tensorboard tensorboardX thop rich pycocotools shapely terminaltables yapf \
        opencv-python onnxruntime opencv-python-headless python-dotenv timm importlib-metadata

    # OpenMMLab系パッケージのインストール
    /opt/conda/bin/mim install mmdet==3.3.0 mmengine==0.10.4 mmyolo==0.6.0

    # ローカルファイルを編集可能モードでインストール
    /opt/conda/bin/pip install -e /opt/mmcv -v
    /opt/conda/bin/pip install -e /opt/mmaction2

    # CUDA環境変数の再設定
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
    export FORCE_CUDA="1"

%runscript
    exec /bin/bash

%test
    echo "[System Validation]"
    echo "1. Conda Version: $(/opt/conda/bin/conda --version)"
    echo "2. Python Path: $(which python)"
    echo "3. PyTorch Version: $(python -c 'import torch; print(torch.__version__)')"
    echo "4. OpenCV Version: $(python -c 'import cv2; print(cv2.__version__)')"
    echo "5. CUDA Available: $(python -c 'import torch; print(torch.cuda.is_available())')"
